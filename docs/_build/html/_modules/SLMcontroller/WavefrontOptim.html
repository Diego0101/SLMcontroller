<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SLMcontroller.WavefrontOptim &mdash; SLM controller 1.0.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=baaebd52"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SLM controller
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">How to</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Calibration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">SLMcontroller</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SLM controller</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../SLMcontroller.html">SLMcontroller</a></li>
      <li class="breadcrumb-item active">SLMcontroller.WavefrontOptim</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SLMcontroller.WavefrontOptim</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;WavefrontOptim.py: Generates a tab used to control the spot optimization process.&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Mazzanti&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2022, Matteo Mazzanti&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;GNU GPL v3&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Mazzanti&quot;</span>

<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">PyQt6.QtWidgets</span> <span class="kn">import</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QSlider</span><span class="p">,</span> <span class="n">QDoubleSpinBox</span><span class="p">,</span><span class="n">QGridLayout</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QGroupBox</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QFileDialog</span>
<span class="kn">from</span> <span class="nn">PyQt6.QtCore</span> <span class="kn">import</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QMutex</span><span class="p">,</span> <span class="n">QWaitCondition</span>



<span class="kn">import</span> <span class="nn">SLMcontroller.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">abort</span>


<div class="viewcode-block" id="SpotOptimTab_ext">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext">[docs]</a>
<span class="k">class</span> <span class="nc">SpotOptimTab_ext</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spot optimization tab used to control the spot optimization process.</span>
<span class="sd">    The algorithm is based on https://www.nature.com/articles/nphoton.2010.85.</span>

<span class="sd">    This code is meant to be controlled remotely from a separate acquisition system that will measure the intensity of the interference between probe and reference zones.</span>
<span class="sd">    </span>
<span class="sd">    The control is done via Flask. The following endpoints are available:</span>
<span class="sd">        - /optimiser/start : starts the algorithm (if already running, triggers a next step).</span>
<span class="sd">        - /optimiser/nextStep : triggers the next step of the algorithm (once scaned till the end of the phase pattern, this will return phase = null).</span>
<span class="sd">        - /optimiser/refzone : returns the current reference zone</span>
<span class="sd">        - /optimiser/refzone/&lt;refzone&gt; : sets the reference zone to &lt;refzone&gt;</span>
<span class="sd">        - /optimiser/probzone : returns the current probe zone</span>
<span class="sd">        - /optimiser/probzone/&lt;probzone&gt; : sets the probe zone to &lt;probzone&gt;</span>
<span class="sd">        - /optimiser/phase : returns the current phase</span>
<span class="sd">        - /optimiser/phase/&lt;phase&gt; : sets the phase to &lt;phase&gt;</span>
<span class="sd">        - /optimiser/phaseStep/&lt;phaseStep&gt; : sets the phase step to &lt;phaseStep&gt;</span>
<span class="sd">        - /optimiser/IDsList : returns the list of IDs of the active optical elements</span>
<span class="sd">        - /optimiser/phasePattern : returns the current phase pattern</span>

<span class="sd">    --- Setting up the algorithm ---</span>
<span class="sd">    First the user has to define the probe and references zones on the SLM. This can be done using gmsh.</span>
<span class="sd">    Mesh parameters and algorithms can be choosen in the tab. Once obtaining a satisfactory meshing this can be saved and loaded later.</span>
<span class="sd">    The mesh can be visualized using the gmsh GUI. This requires to start the GUI on another process as certain OS do not allow GUI to be started outside the main thread.</span>
<span class="sd">    The second process is started at the start of the program and kept dormant if not used.</span>
<span class="sd">    </span>
<span class="sd">    It allows for an user to choose the parameters for 2 gratings:</span>
<span class="sd">        - one to &quot;dump&quot; the 1st order power of the SLM to an unused zone</span>
<span class="sd">        - one to that will be assigned to the reference and probe zones in order to scan for their interference</span>

<span class="sd">    Once chosen the parameters the code will parse all the zones in the mesh and assign them a tag. </span>
<span class="sd">    The user can then choose the reference and probe zones from the GUI.</span>

<span class="sd">    Starting the algorithm will allow to scan the selected reference zone phase offset in a range [0,2pi].</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pattern_generator (:Pattern_generator:): Pattern generator object used to generate the grating.</span>
<span class="sd">        settings_manager (:SettingsManager:): Settings manager object used to get the wavelength, SLM resolution and SLM pixel pitch.</span>
<span class="sd">        hologram_manager (:HologramsManager:): Hologram manager object used to update the SLM window.</span>
<span class="sd">        algorithms (list): List of available meshing algorithms.</span>
<span class="sd">        algorithms_names (list): List of names of the available meshing algorithms.</span>
<span class="sd">        openmeshvisualizer (bool): Flag to indicate if the mesh visualizer is open or not.</span>
<span class="sd">        wasINIT (bool): Flag to indicate if the mesh has been initialized or not.</span>
<span class="sd">        th_active (bool): Flag to indicate if the algorithm is running or not.</span>
<span class="sd">        process_step (int): Current step of the algorithm.</span>
<span class="sd">        points (list): List of points used to define the SLM boundaries in the meshing software.</span>
<span class="sd">        lines (list): List of lines used to define the SLM boundaries in the meshing software.</span>
<span class="sd">        SLM_x_res (int): SLM X resolution.</span>
<span class="sd">        SLM_y_res (int): SLM Y resolution.</span>
<span class="sd">        minlmm (float): Minimum number of lines per mm that can be used to generate the grating.</span>
<span class="sd">        maxlmm (float): Maximum number of lines per mm that can be used to generate the grating.</span>
<span class="sd">        lmm_grating (float): Number of lines per mm used to generate the offset grating.</span>
<span class="sd">        angle_grating (float): Angle of the offset grating in radians.</span>
<span class="sd">        lmm_interf_grating (float): Number of lines per mm used to generate the grating used for interference.</span>
<span class="sd">        angle_interf_grating (float): Angle of the grating in radians used for interference.</span>
<span class="sd">        meshProcess (:MeshingProcess:): Meshing process object used to generate and visualize the mesh.</span>
<span class="sd">        mutex (:QMutex:): Mutex used to control the second process.</span>
<span class="sd">        waitCond (:QWaitCondition:): Wait condition used to control the second process.</span>
<span class="sd">        theOptimizer (:OptimizerAlgorithm:): Optimizer algorithm object used to control the second process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor for the SpotOptimTab_ext class. Stops the optimization thread and closes the mesh GUI process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_algo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_mesh</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_generator</span><span class="p">,</span> <span class="n">settings_manager</span><span class="p">,</span> <span class="n">hologram_manager</span><span class="p">,</span> <span class="n">meshing_process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for the SpotOptimTab_ext class.</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern_generator (:Pattern_generator:): Pattern generator object used to generate the grating.</span>
<span class="sd">            settings_manager (:SettingsManager:): Settings manager object used to get the wavelength, SLM resolution and SLM pixel pitch.</span>
<span class="sd">            hologram_manager (:HologramsManager:): Hologram manager object used to update the SLM window.</span>
<span class="sd">            meshing_process (:MeshingProcess:): Meshing process object used to generate and visualize the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern_generator</span> <span class="o">=</span> <span class="n">pattern_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span> <span class="o">=</span> <span class="n">settings_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hologram_manager</span> <span class="o">=</span> <span class="n">hologram_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithms_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MeshAdapt&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic&quot;</span><span class="p">,</span> <span class="s2">&quot;Initial mesh only&quot;</span><span class="p">,</span> <span class="s2">&quot;Delaunay&quot;</span><span class="p">,</span> <span class="s2">&quot;Frontal-Delaunay&quot;</span><span class="p">,</span> <span class="s2">&quot;BAMG&quot;</span><span class="p">,</span> <span class="s2">&quot;Frontal-Delaunay quads&quot;</span><span class="p">,</span> <span class="s2">&quot;Packing paralleograms&quot;</span><span class="p">,</span><span class="s2">&quot;Quasi-structured Quad&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openmeshvisualizer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wasINIT</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">th_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_step</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 4 points array where to store the points tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 4 points array where to store the lines tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_X_res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_Y_res</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minlmm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlmm</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">()</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_GUI</span><span class="p">()</span>

        <span class="c1"># Mesh data matrix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_zones</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment_phase_step</span> <span class="o">=</span> <span class="mi">25</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meshProcess</span> <span class="o">=</span> <span class="n">meshing_process</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">QMutex</span><span class="p">()</span> <span class="c1"># Mutex needs to be given from the controlling thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span> <span class="o">=</span> <span class="n">QWaitCondition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span> <span class="o">=</span> <span class="n">OptimizerAlgorithm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hologram_manager</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern_generator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="p">)</span>

<div class="viewcode-block" id="SpotOptimTab_ext.setEventsHandlers">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.setEventsHandlers">[docs]</a>
    <span class="k">def</span> <span class="nf">setEventsHandlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eventsDict</span><span class="p">,</span> <span class="n">conditionsDict</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the events handlers for the class.</span>
<span class="sd">         As for the gmsh GUI process, Events and Conditions are generated in __main__ and passed to the class.</span>
<span class="sd">         Events are used to trigger actions in the meshProcess process (e.g. generate mesh, load mesh, save mesh, etc.)</span>
<span class="sd">         Conditions are used to synchronize the two processes (e.g. wait for the mesh to be generated before loading it)</span>

<span class="sd">        Args:</span>
<span class="sd">            eventsDict (dict): Dictionary containing the events.</span>
<span class="sd">            conditionsDict (dict): Dictionary containing the conditions.</span>
<span class="sd">            queue (queue): Queue used to communicate with the gmsh GUI process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Called after initializing the class, here we give the object control over the mutex to control the second process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span> <span class="o">=</span> <span class="n">eventsDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span> <span class="o">=</span> <span class="n">conditionsDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span></div>



<div class="viewcode-block" id="SpotOptimTab_ext.init_GUI">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.init_GUI">[docs]</a>
    <span class="k">def</span> <span class="nf">init_GUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the GUI elements of the tab.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span> <span class="o">=</span>  <span class="n">QGridLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showmesh_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">meshparams_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo_zones_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_zone_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probe_zone_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interf_groupbox</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Interference zone&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_groupbox</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Diffractive grating&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">showmeshbutton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Show Mesh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generatemeshbutton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Generate Mesh&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closemeshbutton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Close Mesh&quot;</span><span class="p">)</span>

        <span class="c1"># Load and save mesh buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadmeshbutton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Load mesh file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemeshbutton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Save mesh file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadmeshbutton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadMeshFromFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemeshbutton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMeshToFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmeshbutton</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">savemeshbutton</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parseMeshButton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Parse phases from mesh (slow)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parseMeshButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_mesh_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runAlgorithmButton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Next step (Start)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runAlgorithmButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_algo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopAlgorithmButton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Stop optimization&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopAlgorithmButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_algo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">list_algorithms</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithms_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_algorithms</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">showmeshbutton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshF</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s2">&quot;2.5*((x-0.5)*(x-0.5)+(y-0.5)*(y-0.5))+ 10&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generatemeshbutton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshF</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closemeshbutton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_mesh</span><span class="p">)</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">meshparams_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meshparams_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_algorithms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meshparams_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showmeshbutton</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closemeshbutton</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generatemeshbutton</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadshowmeshlayout</span><span class="p">)</span>

        <span class="c1"># This for the parameters of the grating used for interference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="c1">#self.grating_angle_layout = QVBoxLayout()</span>
        <span class="c1">#self.interf_grating_angle_layout = QVBoxLayout()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_spin</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Grating angle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_spin</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Grating angle&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_spin</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;l/mm &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_spin</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;l/mm &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_slider</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DoubleSlider</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_slider</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DoubleSlider</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_slider</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DoubleSlider</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_slider</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">DoubleSlider</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_lmm_slider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grating_layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_slider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_grating_lmm_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_grating_lmm_slide</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_lmm_slider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_slider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_interf_grating_lmm_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_interf_grating_lmm_slide</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_angle_slider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grating_layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_slider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_grating_angle_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_grating_angle_slide</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_angle_slider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_layout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_spin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_slider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_interf_grating_angle_spin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_interf_grating_angle_slide</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">grating_groupbox</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grating_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_groupbox</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grating_groupbox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_groupbox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parseMeshButton</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectRefZone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectProbZone</span><span class="p">)</span>
        
        <span class="n">label_reference_zone</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Reference zone:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">label_probe_zone</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Probe zone:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_zone_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label_reference_zone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_zone_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probe_zone_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label_probe_zone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probe_zone_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algo_zones_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_zone_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo_zones_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_zone_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algo_zones_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algo_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runAlgorithmButton</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algo_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stopAlgorithmButton</span><span class="p">)</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algo_controls_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.selectRefZone">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.selectRefZone">[docs]</a>
    <span class="k">def</span> <span class="nf">selectRefZone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the reference zone when the user selects a new one from the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we don&#39;t have elements in the ComboBox, a mesh update will empty the list</span>
        <span class="c1"># Emptying the list will trigger a value update that will try to do int(&#39;&#39;) crashing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.selectProbZone">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.selectProbZone">[docs]</a>
    <span class="k">def</span> <span class="nf">selectProbZone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the probe zone when the user selects a new one from the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we don&#39;t have elements in the ComboBox, a mesh update will empty the list</span>
        <span class="c1"># Emptying the list will trigger a value update that will try to do int(&#39;&#39;) crashing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.loadMeshFromFile">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.loadMeshFromFile">[docs]</a>
    <span class="k">def</span> <span class="nf">loadMeshFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a mesh from a file in gmsh .msh format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Opens a prompt for the user to select a mesh file</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;Open File&quot;</span><span class="p">,</span><span class="s2">&quot;$</span><span class="si">{HOME}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;GMSH (*.msh);;&quot;</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putVariablesInQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;loadfile&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;generalEvent&#39;</span><span class="p">])</span>
        <span class="c1"># self.eventsDict[&#39;loadfile&#39;].set()</span>
        <span class="c1"># self.eventsDict[&#39;generalEvent&#39;].set()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;loadfile&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;loadfile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outcome</span><span class="p">:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;ERROR!&quot;</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;There was an error loading the mesh file, check the file and try again&quot;</span><span class="p">)</span>
            <span class="n">button</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">button</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
                <span class="k">return</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.saveMeshToFile">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.saveMeshToFile">[docs]</a>
    <span class="k">def</span> <span class="nf">saveMeshToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the current mesh to a file in gmsh .msh format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Save File&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;GMSH (*.msh);;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;savefile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;generalEvent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;savefile&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;savefile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outcome</span><span class="p">:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;ERROR!&quot;</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;There was an error saving the mesh file, check the file and try again&quot;</span><span class="p">)</span>
            <span class="n">button</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">button</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
                <span class="k">return</span></div>




<div class="viewcode-block" id="SpotOptimTab_ext.populate_zone_selector">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.populate_zone_selector">[docs]</a>
    <span class="k">def</span> <span class="nf">populate_zone_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populates the reference and probe zone selection comboboxes once the mesh has been generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.is_active">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.is_active">[docs]</a>
    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the status of the algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
    <span class="c1"># This part for setting the grating parameters needed for generating constructing/distructive interference</span>

<div class="viewcode-block" id="SpotOptimTab_ext.make_lmm_slider">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.make_lmm_slider">[docs]</a>
    <span class="k">def</span> <span class="nf">make_lmm_slider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmm_layout</span><span class="p">,</span> <span class="n">spin_lmm</span><span class="p">,</span> <span class="n">lmm_slider</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the slider to control the offset grating parameters and adds it to the GUI.</span>

<span class="sd">        Args:</span>
<span class="sd">            lmm_layout (:QVBoxLayout:): Layout to which the slider will be added.</span>
<span class="sd">            spin_lmm (:QDoubleSpinBox:): Spinbox to control the offset grating parameters.</span>
<span class="sd">            lmm_slider (:utils.DoubleSlider:): Slider to control the offset grating parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.lmm_layout = QVBoxLayout()</span>
        <span class="n">lmm</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1">#self.spin_lmm = QDoubleSpinBox(text=&quot;l/mm &quot;)</span>
        <span class="n">spin_lmm</span><span class="o">.</span><span class="n">setSuffix</span><span class="p">(</span><span class="s1">&#39; l/mm&#39;</span><span class="p">)</span>
        <span class="c1">#spin_lmm.valueChanged.connect(lambda : self.update_lmm_slide(lmm, spin_lmm))</span>
            
        <span class="n">spin_lmm</span><span class="o">.</span><span class="n">setKeyboardTracking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spin_lmm</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">spin_lmm</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlmm</span><span class="p">)</span>
        <span class="n">spin_lmm</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minlmm</span><span class="p">)</span>

        <span class="n">lmm_slider</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">lmm_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lmm_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlmm</span><span class="p">)</span>
        <span class="n">lmm_slider</span><span class="o">.</span><span class="n">setTickPosition</span><span class="p">(</span><span class="n">QSlider</span><span class="o">.</span><span class="n">TickPosition</span><span class="o">.</span><span class="n">TicksBelow</span><span class="p">)</span>
        <span class="n">lmm_slider</span><span class="o">.</span><span class="n">setTickInterval</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>

        <span class="n">lmm_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spin_lmm</span><span class="p">)</span>
        <span class="n">lmm_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lmm_slider</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.make_angle_slider">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.make_angle_slider">[docs]</a>
    <span class="k">def</span> <span class="nf">make_angle_slider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle_layout</span><span class="p">,</span> <span class="n">spin_angle</span><span class="p">,</span> <span class="n">angle_slider</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the slider to control the offset grating parameters and adds it to the GUI.</span>

<span class="sd">        Args:</span>
<span class="sd">            angle_layout (:QVBoxLayout:): Layout to which the slider will be added.</span>
<span class="sd">            spin_angle (:QDoubleSpinBox:): Spinbox to control the offset grating parameters.</span>
<span class="sd">            angle_slider (:utils.DoubleSlider:): Slider to control the offset grating parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spin_angle</span><span class="o">.</span><span class="n">setSuffix</span><span class="p">(</span><span class="s1">&#39; π&#39;</span><span class="p">)</span>
        <span class="n">spin_angle</span><span class="o">.</span><span class="n">setKeyboardTracking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spin_angle</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>


        <span class="n">angle_slider</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">angle_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Maximum number of lines per mm is limited by the pixel pitch of the SLM (better even avoiding getting closer to this limit)</span>
        <span class="n">angle_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">angle_slider</span><span class="o">.</span><span class="n">setTickInterval</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">angle_slider</span><span class="o">.</span><span class="n">setTickPosition</span><span class="p">(</span><span class="n">QSlider</span><span class="o">.</span><span class="n">TickPosition</span><span class="o">.</span><span class="n">TicksBelow</span><span class="p">)</span>
        
        <span class="n">angle_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spin_angle</span><span class="p">)</span>
        <span class="n">angle_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">angle_slider</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.setRefZone">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.setRefZone">[docs]</a>
    <span class="k">def</span> <span class="nf">setRefZone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refzone</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the reference zone.</span>

<span class="sd">        Args:</span>
<span class="sd">            refzone (int/str): Reference zone to set. Flask will input this as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refzone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">refzone</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">refzone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">refzone</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span><span class="p">):</span>
            <span class="c1"># Change ref zone in the GUI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zones_ref_combobox</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">refzone</span><span class="p">))</span>
            <span class="c1"># Set the new reference zone</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">refzone</span><span class="p">)</span>
            <span class="c1"># Change it also in the algorithm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">refzone</span><span class="p">)</span>
            <span class="c1"># Return the value of the new reference zone</span>
            <span class="c1"># Used for Flask as a return code to double check everything went fine</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.getProbRefZone">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.getProbRefZone">[docs]</a>
    <span class="k">def</span> <span class="nf">getProbRefZone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the zones IDs and optimizer process state (running/not running) zone remotely</span>

<span class="sd">        Returns:</span>
<span class="sd">             json(Reference zone, Probe zone, Phase, Optimizer status): Returns information on the probe zone, reference zone and current phase in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the algorithm is running take the ref_zone from it (more updated)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadRunning</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadRunning</span><span class="p">())</span>
        <span class="c1"># Otherwise use the one shown in the GUI</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadRunning</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.setProbZone">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.setProbZone">[docs]</a>
    <span class="k">def</span> <span class="nf">setProbZone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">probzone</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the probe zone remotely</span>
<span class="sd">         Args:</span>
<span class="sd">            probzone (int/str): Probe zone to set. Flask will input this as a string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            json(Probe zone, Reference zone, Phase): Returns information on the probe zone, reference zone and current phase in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">probzone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">probzone</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">probzone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">probzone</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zones_prob_combobox</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">probzone</span><span class="p">))</span>
            <span class="c1"># Set the new reference zone</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">probzone</span><span class="p">)</span>
            <span class="c1"># Change it also in the algorithm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">probzone</span><span class="p">)</span>
            <span class="c1"># Return the value of the new reference zone</span>
            <span class="c1"># Used for Flask as a return code to double check everything went fine</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.setPhase">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.setPhase">[docs]</a>
    <span class="k">def</span> <span class="nf">setPhase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the phase remotely</span>

<span class="sd">        Args:</span>
<span class="sd">            phase (int/str): Phase to set. Flask will input this as a string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            json(Probe zone, Reference zone, Phase): Returns information on the probe zone, reference zone and current phase in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.setPhaseStep">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.setPhaseStep">[docs]</a>
    <span class="k">def</span> <span class="nf">setPhaseStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">phaseStep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the phase step remotely. The phase steps is the amount of phase used to increase the phase of the reference zone at each step of the algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            phaseStep (int/str): Phase step to set. Flask will input this as a string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            json(Probe zone, Reference zone, Phase, PhaseStep): Returns information on the probe zone, reference zone, current phase and phase steps in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phaseStep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">phaseStep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phaseStep</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">phaseStep</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phaseStep</span> <span class="o">=</span> <span class="n">phaseStep</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span> <span class="p">,</span><span class="n">PhaseStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phaseStep</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.checkAlgoReady">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.checkAlgoReady">[docs]</a>
    <span class="k">def</span> <span class="nf">checkAlgoReady</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Invalid gratings settings&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">):</span>
            <span class="k">return</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Invalid probe/reference zone&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadReady</span><span class="p">():</span>
            <span class="k">return</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Mesh not ready&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="SpotOptimTab_ext.start_algo_rem">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.start_algo_rem">[docs]</a>
    <span class="k">def</span> <span class="nf">start_algo_rem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the optimization algorithm remotely. If the algorithm is alredy running, triggers a next step.</span>
<span class="sd">        Unfortunately not all OS allow to use the start_algo function (as that will require to open new GUI windows)</span>
<span class="sd">        For this reason this is more or less a &quot;Duplicate window&quot; of the start_algo function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadRunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="o">.</span><span class="n">wakeAll</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkAlgoReady</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span>
        <span class="c1"># If the phase step was not set (e.g. first time running the algorithm) set it to 1/10 of the phase range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phaseStep</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phaseStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_phase_correction</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span>
        <span class="c1"># If the phase was not set (e.g. first time running the algorithm) set it to 0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.getPhasePattern">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.getPhasePattern">[docs]</a>
    <span class="k">def</span> <span class="nf">getPhasePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">getPhasePattern</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;No pattern defined&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">PhasePattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">getPhasePattern</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.getPhasePatternIMG">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.getPhasePatternIMG">[docs]</a>
    <span class="k">def</span> <span class="nf">getPhasePatternIMG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the phase pattern</span>

<span class="sd">        Returns:</span>
<span class="sd">            HTTP Response IMG (Phase pattern): Returns information on the current phase pattern in PNG image format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">getPhasePattern</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;No pattern defined&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">getPhasePattern</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">))</span>
        <span class="c1"># create file-object in memory</span>
        <span class="n">file_object</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="c1"># write PNG in file-object</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_object</span><span class="p">,</span> <span class="s1">&#39;PNG&#39;</span><span class="p">)</span>
        <span class="c1"># move to beginning of file so `send_file()` it will read from start </span>
        <span class="n">file_object</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">file_object</span><span class="p">,</span><span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/PNG&#39;</span><span class="p">,</span><span class="n">as_attachment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">download_name</span><span class="o">=</span><span class="s1">&#39;pattern.png&#39;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.getIdsList">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.getIdsList">[docs]</a>
    <span class="k">def</span> <span class="nf">getIdsList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the IDs list</span>

<span class="sd">        Returns:</span>
<span class="sd">            json(IDs list): Returns information on the current IDs list in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">ids_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">IDsList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.triggerNextStep">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.triggerNextStep">[docs]</a>
    <span class="k">def</span> <span class="nf">triggerNextStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Triggers the next step of the algorithm</span>

<span class="sd">        Returns:</span>
<span class="sd">            json(Phase) : Returns information on the current phase of the probe zone in json format for remote clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="o">.</span><span class="n">wakeAll</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">RefZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span><span class="p">,</span><span class="n">ProbZone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span><span class="p">,</span><span class="n">Phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_grating_lmm_slide">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_grating_lmm_slide">[docs]</a>
    <span class="k">def</span> <span class="nf">update_grating_lmm_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the offset grating lmm in the slider when the user changes the spin value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_grating_lmm_spin">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_grating_lmm_spin">[docs]</a>
    <span class="k">def</span> <span class="nf">update_grating_lmm_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the offset grating lmm in the spinbox when the user changes the slider value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_interf_grating_lmm_slide">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_interf_grating_lmm_slide">[docs]</a>
    <span class="k">def</span> <span class="nf">update_interf_grating_lmm_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the interference grating lmm in the slider when the user changes the spin value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span><span class="p">)</span> </div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_interf_grating_lmm_spin">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_interf_grating_lmm_spin">[docs]</a>
    <span class="k">def</span> <span class="nf">update_interf_grating_lmm_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the interference grating lmm in the spinbox when the user changes the slider value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_grating_angle_slide">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_grating_angle_slide">[docs]</a>
    <span class="k">def</span> <span class="nf">update_grating_angle_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the offset grating angle in the slider when the user changes the spin value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_grating_angle_spin">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_grating_angle_spin">[docs]</a>
    <span class="k">def</span> <span class="nf">update_grating_angle_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the offset grating angle in the spinbox when the user changes the slider value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_interf_grating_angle_slide">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_interf_grating_angle_slide">[docs]</a>
    <span class="k">def</span> <span class="nf">update_interf_grating_angle_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the interference grating angle in the slider when the user changes the spin value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span><span class="p">)</span> </div>


<div class="viewcode-block" id="SpotOptimTab_ext.update_interf_grating_angle_spin">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.update_interf_grating_angle_spin">[docs]</a>
    <span class="k">def</span> <span class="nf">update_interf_grating_angle_spin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the interference grating angle in the spinbox when the user changes the slider value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.load_zones">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.load_zones">[docs]</a>
    <span class="k">def</span> <span class="nf">load_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the reference and probe zones from the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Activate probe and reference zones</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">zone</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span> <span class="ow">or</span> <span class="n">zone</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_zones</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.stop_algo">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.stop_algo">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_algo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stops the optimization algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping optimization&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="o">.</span><span class="n">wakeAll</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SpotOptimTab_ext.putVariablesInQueue">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.putVariablesInQueue">[docs]</a>
    <span class="k">def</span> <span class="nf">putVariablesInQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">notify</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Puts the variables needed to generate the mesh in the queue and notifies the second process.</span>

<span class="sd">        Args:</span>
<span class="sd">            queue (queue): Queue used to communicate with the gmsh GUI process.</span>
<span class="sd">            event (event): Event used to notify the second process what to do (e.g. generate mesh, render mesh etc.).</span>
<span class="sd">            notify (event): Event used to notify the second process that data is ready.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_X_res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_Y_res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_algorithms</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshF</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>
        <span class="c1"># Notifies the second process that data is ready</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.show_mesh">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.show_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">show_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notifies the gmsh process to render the mesh in the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;showGUI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;generalEvent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="SpotOptimTab_ext.close_mesh">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.close_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">close_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notifies the gmsh process to close meshing visualization the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;closeGUI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpotOptimTab_ext.generate_mesh">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.generate_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">F</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notifies the meshing process that a new mesh should be generated and which parameter (function) to use.</span>

<span class="sd">        Args:</span>
<span class="sd">            F (string): Function used to generate the mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putVariablesInQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;genMesh&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;generalEvent&#39;</span><span class="p">])</span></div>

        <span class="c1"># Waiting for second process to generate the Mesh</span>
        <span class="c1">#print(&quot;aked to generate&quot;)</span>

<div class="viewcode-block" id="SpotOptimTab_ext.load_mesh_ids">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.load_mesh_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">load_mesh_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notifies the second process to start parsing the mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now parsing, please wait...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;parseMesh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventsDict</span><span class="p">[</span><span class="s1">&#39;generalEvent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;parsingCond&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditionsDict</span><span class="p">[</span><span class="s1">&#39;parsingCond&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_zone_selector</span><span class="p">()</span>
        <span class="c1"># Set mesh and ID list also in optimizer algorith</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">ids_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids_list</span></div>



<div class="viewcode-block" id="SpotOptimTab_ext.start_algo">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.SpotOptimTab_ext.start_algo">[docs]</a>
    <span class="k">def</span> <span class="nf">start_algo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the optimization algorithm. If the algorithm is alredy running, triggers a next step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">isThreadRunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="o">.</span><span class="n">wakeAll</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkAlgoReady</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;ERROR!&quot;</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">button</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">button</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">probZoneID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">refZoneID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_zone</span>
        <span class="c1"># TODO : For now hardcoded a step of ~25 (maxphase (usually ~255)/10), to be user-selectable</span>
        <span class="c1"># Default to maxphase/10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phaseStep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_phase_correction</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span>

        <span class="c1"># TODO : Let user choose a starting phase. This can be done only remotely ATM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmm_grating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_grating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmm_interf_grating</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_interf_grating</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theOptimizer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> </div>
</div>





<div class="viewcode-block" id="OptimizerAlgorithm">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm">[docs]</a>
<span class="k">class</span> <span class="nc">OptimizerAlgorithm</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class used to control the optimization algorithm.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pattern_generator (:Pattern_generator:): Pattern generator object used to generate the grating.</span>
<span class="sd">        settings_manager (:SettingsManager:): Settings manager object used to get the wavelength, SLM resolution and SLM pixel pitch.</span>
<span class="sd">        hologram_manager (:HologramsManager:): Hologram manager object used to update the SLM window.</span>
<span class="sd">        pattern (np.array): Phase pattern used to generate the grating.</span>
<span class="sd">        pattern_generator (:Pattern_generator:): Pattern generator object used to generate the grating.</span>
<span class="sd">        settings_manager (:SettingsManager:): Settings manager object used to get the wavelength, SLM resolution and SLM pixel pitch.</span>
<span class="sd">        _mesh (np.array): Mesh used to generate the grating.</span>
<span class="sd">        SLM_x_res (int): SLM X resolution.</span>
<span class="sd">        SLM_y_res (int): SLM Y resolution.</span>
<span class="sd">        _ids_list (list): List of IDs used to define the zones in the mesh.</span>
<span class="sd">        _phaseStep (int): Phase step used to increment the phase of the reference zone at each step of the algorithm.</span>
<span class="sd">        _probZoneID (int): Probe zone ID.</span>
<span class="sd">        _refZoneID (int): Reference zone ID.</span>
<span class="sd">        _prevzones (list): List of the previous probe and reference zones.</span>
<span class="sd">        hologram_manager (:HologramsManager:): Hologram manager object used to update the SLM window.</span>
<span class="sd">        _active (bool): Flag to indicate if the algorithm is running or not.</span>
<span class="sd">        waitCond (:QWaitCondition:): Wait condition used to control the second process.</span>
<span class="sd">        trigger (:QMutex:): Mutex used to control the second process.</span>
<span class="sd">        phase (int): Current phase of the reference zone.</span>
<span class="sd">        grating_lastvals (np.array): Last values of the grating parameters.</span>
<span class="sd">        interf_grating_lastvals (np.array): Last values of the grating parameters used for interference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hologram_manager</span><span class="p">,</span> <span class="n">pattern_generator</span><span class="p">,</span> <span class="n">settings_manager</span><span class="p">,</span><span class="n">mutex</span><span class="p">,</span><span class="n">waitCond</span><span class="p">):</span>
            <span class="n">QThread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pattern_generator</span> <span class="o">=</span> <span class="n">pattern_generator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span> <span class="o">=</span> <span class="n">settings_manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ids_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phaseStep</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prevzones</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hologram_manager</span> <span class="o">=</span> <span class="n">hologram_manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isPhaseReady</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">mutex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span> <span class="o">=</span> <span class="n">waitCond</span>

            <span class="c1"># Save last grating parameters to avoid re-generating the grating</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grating_lastvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lastvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

<div class="viewcode-block" id="OptimizerAlgorithm.activate">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.activate">[docs]</a>
    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">grating_lmm</span><span class="p">,</span> <span class="n">grating_angle</span><span class="p">,</span><span class="n">interf_grating_lmm</span><span class="p">,</span><span class="n">interf_grating_angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Activates the algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            grating_lmm (float): l/mm of the offset grating.</span>
<span class="sd">            grating_angle (float): Angle of the offset grating.</span>
<span class="sd">            interf_grating_lmm (float): l/mm of the interference grating.</span>
<span class="sd">            interf_grating_angle (float): Angle of the interference grating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setGrating</span><span class="p">(</span><span class="n">grating_lmm</span><span class="p">,</span> <span class="n">grating_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setInterfGrating</span><span class="p">(</span><span class="n">interf_grating_lmm</span><span class="p">,</span><span class="n">interf_grating_angle</span><span class="p">)</span></div>


<div class="viewcode-block" id="OptimizerAlgorithm.run">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the optimization algorithm. The algorithm will wait for a waitCond signal before proceeding to the next step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initPattern</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_step</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_phase_correction</span><span class="p">()</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waitCond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="OptimizerAlgorithm.stop">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stops the optimization algorithm.</span>

<span class="sd">        Todo:</span>
<span class="sd">            Save the data (meshing zones, phases etc.) somewhere here (not sure if useful). Re-init important local variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="OptimizerAlgorithm.next_step">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.next_step">[docs]</a>
    <span class="k">def</span> <span class="nf">next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Moves to the next step of the optimization algorithm</span>
<span class="sd">        Checks that gratings and zones parameters weren&#39;t changed (perhaps remotely)</span>
<span class="sd">        If they were it needs to regenerate the grating patterns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remeshing</span><span class="p">()</span>
        <span class="c1"># If the user changed the zones call the slower function to reload the gratings patterns on the previous zones</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prevzones</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">load_pattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_pattern</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_pattern</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">next_step_fast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phase offset at this step: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">)</span>
        
        <span class="c1"># Increment phase for next step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phaseStep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hologram_manager</span><span class="o">.</span><span class="n">renderAlgorithmPattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prevzones</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span><span class="p">]</span></div>

        


<div class="viewcode-block" id="OptimizerAlgorithm.setInterfGrating">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.setInterfGrating">[docs]</a>
    <span class="k">def</span> <span class="nf">setInterfGrating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interf_grating_lmm</span><span class="p">,</span><span class="n">interf_grating_angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the parameters of the interference grating.</span>

<span class="sd">        Args:</span>
<span class="sd">            interf_grating_lmm (float): l/mm of the interference grating.</span>
<span class="sd">            interf_grating_angle (float): Angle of the interference grating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm</span> <span class="o">=</span> <span class="n">interf_grating_lmm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle</span> <span class="o">=</span> <span class="n">interf_grating_angle</span></div>


<div class="viewcode-block" id="OptimizerAlgorithm.setGrating">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.setGrating">[docs]</a>
    <span class="k">def</span> <span class="nf">setGrating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grating_lmm</span><span class="p">,</span> <span class="n">grating_angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the parameters of the offset grating.</span>

<span class="sd">        Args:</span>
<span class="sd">            grating_lmm (float): l/mm of the offset grating.</span>
<span class="sd">            grating_angle (float): Angle of the offset grating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm</span> <span class="o">=</span> <span class="n">grating_lmm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span> <span class="o">=</span> <span class="n">grating_angle</span></div>

    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span>
    
    <span class="nd">@mesh</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the mesh used to separate the SLM in zones.</span>
<span class="sd">        NOTE: This is a bit stupid as we do not clone the mesh here with copy/np.copy.</span>
<span class="sd">        This is intended as we want to use the same mesh as the GUI tab object.</span>
<span class="sd">        However, what&#39;s stupid is to have a private object that is a pointer to an object owned by an object of another class.</span>
<span class="sd">        Anyways, this is how it is for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="n">mesh</span>

    <span class="c1"># This to be used only when forcing the algorithm to start at a previous phase</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the phase of the reference zone.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Phase of the reference zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span>

    <span class="nd">@phase</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the phase of the reference zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase</span> <span class="o">=</span> <span class="n">phase</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phaseStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the phase step used to increment the phase of the reference zone at each step of the algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Phase step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phaseStep</span>
    
    <span class="nd">@phaseStep</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">phaseStep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phaseStep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the phase step used to increment the phase of the reference zone at each step of the algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            phaseStep (float): Phase step to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phaseStep</span> <span class="o">=</span> <span class="n">phaseStep</span>

    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">probZoneID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the probe zone ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Probe zone ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span>

    <span class="nd">@probZoneID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">probZoneID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">probZoneID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the probe zone.</span>

<span class="sd">        Args:</span>
<span class="sd">            probZoneID (int): Probe zone ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span> <span class="o">=</span> <span class="n">probZoneID</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">refZoneID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the reference zone ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Reference zone ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span>
    
    <span class="nd">@refZoneID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">refZoneID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refZoneID</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the reference zone.</span>

<span class="sd">        Args:</span>
<span class="sd">            refZoneID (int): Reference zone ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span> <span class="o">=</span> <span class="n">refZoneID</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ids_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the IDs list (list of available zones)</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of available zones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids_list</span>
    
    <span class="nd">@ids_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ids_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the IDs list (list of available zones). </span>
<span class="sd">        Here is intendend to don&#39;t use np.copy() as we want the optimizer to use the same ID list as the GUI.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids_list (list): List of available zones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ids_list</span> <span class="o">=</span> <span class="n">ids_list</span>

    
<div class="viewcode-block" id="OptimizerAlgorithm.getPhasePattern">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.getPhasePattern">[docs]</a>
    <span class="k">def</span> <span class="nf">getPhasePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the phase pattern.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: Phase pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span></div>


<div class="viewcode-block" id="OptimizerAlgorithm.isThreadReady">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.isThreadReady">[docs]</a>
    <span class="k">def</span> <span class="nf">isThreadReady</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the algorithm is ready to start.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the algorithm is ready to start.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="OptimizerAlgorithm.isThreadRunning">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.isThreadRunning">[docs]</a>
    <span class="k">def</span> <span class="nf">isThreadRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the algorithm is running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the algorithm is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span></div>

    
<div class="viewcode-block" id="OptimizerAlgorithm.remeshing">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.remeshing">[docs]</a>
    <span class="k">def</span> <span class="nf">remeshing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the grating parameters were changed and if so, regenerates the grating patterns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grating_lastvals</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">]))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lastvals</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;remeshing&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grating_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern_generator</span><span class="o">.</span><span class="n">GenerateGrating</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern_generator</span><span class="o">.</span><span class="n">GenerateGrating</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grating_lastvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lastvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_pixel_pitch</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_lmm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">])</span></div>



<div class="viewcode-block" id="OptimizerAlgorithm.initPattern">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.OptimizerAlgorithm.initPattern">[docs]</a>
    <span class="k">def</span> <span class="nf">initPattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the phase patterns for offset and interference gratings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializating ... &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_X_res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_manager</span><span class="o">.</span><span class="n">get_Y_res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remeshing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">load_pattern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_pattern</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interf_grating_pattern</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_x_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SLM_y_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_refZoneID</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_probZoneID</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... done&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="next_step_fast">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.next_step_fast">[docs]</a>
<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">next_step_fast</span><span class="p">(</span><span class="n">SIZEX</span><span class="p">,</span> <span class="n">SIZEY</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">interf_grating</span><span class="p">,</span> <span class="n">probZoneID</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates the next step of the optimization algorithm. Uses jit from numba to speed up the computation.</span>
<span class="sd">    This updates only the part of the pattern corresponding to the probe zone.</span>
<span class="sd">    In case the probe/reference zones have been changed load_pattern should be used instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        SIZEX (int): SLM X resolution.</span>
<span class="sd">        SIZEY (int): SLM Y resolution.</span>
<span class="sd">        mesh (np.array): Mesh used to separate the SLM in zones.</span>
<span class="sd">        interf_grating (np.array): Interference grating pattern.</span>
<span class="sd">        probZoneID (int): Probe zone ID.</span>
<span class="sd">        pattern (np.array): Phase pattern.</span>
<span class="sd">        phase (float): Current phase of the reference zone.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array: New phase pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SIZEY</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SIZEX</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">probZoneID</span><span class="p">:</span>
                <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">interf_grating</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span>
    <span class="k">return</span> <span class="n">pattern</span></div>




<div class="viewcode-block" id="load_pattern">
<a class="viewcode-back" href="../../SLMcontroller.html#SLMcontroller.WavefrontOptim.load_pattern">[docs]</a>
<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Set &quot;nopython&quot; mode for best performance, equivalent to @njit</span>
<span class="k">def</span> <span class="nf">load_pattern</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">grating</span><span class="p">,</span> <span class="n">interf_grating</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">SIZEX</span><span class="p">,</span> <span class="n">SIZEY</span><span class="p">,</span> <span class="n">refZoneID</span><span class="p">,</span> <span class="n">probZoneID</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the phase pattern. Uses jit from numba to speed up the computation.</span>

<span class="sd">    Args:</span>
<span class="sd">        mesh (np.array): Mesh used to separate the SLM in zones.</span>
<span class="sd">        grating (np.array): Offset grating pattern.</span>
<span class="sd">        interf_grating (np.array): Interference grating pattern.</span>
<span class="sd">        phase (float): Current phase of the reference zone.</span>
<span class="sd">        SIZEX (int): SLM X resolution.</span>
<span class="sd">        SIZEY (int): SLM Y resolution.</span>
<span class="sd">        refZoneID (int): Reference zone ID.</span>
<span class="sd">        probZoneID (int): Probe zone ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array: Phase pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">SIZEY</span><span class="p">,</span><span class="n">SIZEX</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SIZEY</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SIZEX</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">refZoneID</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interf_grating</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">probZoneID</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">interf_grating</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span><span class="o">%</span><span class="mi">256</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">grating</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pattern</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Matteo Mazzanti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>